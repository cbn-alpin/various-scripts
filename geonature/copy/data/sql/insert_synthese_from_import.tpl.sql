-- Insert observations into gn_synthese.synthese from gn_imports.synthese.
-- Cross databases import with use of cd_nomenclature, no IDs !
BEGIN;


\echo '----------------------------------------------------------------------------'
\echo 'âž¤ Insert observations into synthese'
INSERT INTO gn_synthese.synthese (
    unique_id_sinp,
    unique_id_sinp_grp,
    id_source,
    entity_source_pk_value,
    id_dataset,
    id_nomenclature_geo_object_nature,
    id_nomenclature_grp_typ,
    grp_method,
    id_nomenclature_obs_technique,
    id_nomenclature_bio_status,
    id_nomenclature_bio_condition,
    id_nomenclature_naturalness,
    id_nomenclature_exist_proof,
    id_nomenclature_valid_status,
    id_nomenclature_diffusion_level,
    id_nomenclature_life_stage,
    id_nomenclature_sex,
    id_nomenclature_obj_count,
    id_nomenclature_type_count,
    id_nomenclature_sensitivity,
    id_nomenclature_observation_status,
    id_nomenclature_blurring,
    id_nomenclature_source_status,
    id_nomenclature_info_geo_type,
    id_nomenclature_behaviour,
    id_nomenclature_biogeo_status,
    reference_biblio,
    count_min,
    count_max,
    cd_nom,
    cd_hab,
    nom_cite,
    meta_v_taxref,
    sample_number_proof,
    digital_proof,
    non_digital_proof,
    altitude_min,
    altitude_max,
    depth_min,
    depth_max,
    place_name,
    the_geom_4326,
    the_geom_point,
    the_geom_local,
    "precision",
    id_area_attachment,
    date_min,
    date_max,
    validator,
    validation_comment,
    observers,
    determiner,
    id_nomenclature_determination_method,
    comment_context,
    comment_description,
    additional_data,
    meta_validation_date,
    meta_create_date,
    meta_update_date,
    last_action
)
    SELECT DISTINCT ON (unique_id_sinp)
        unique_id_sinp,
        unique_id_sinp_grp,
        gn_synthese.get_id_source_by_name('${gn2gn_source}') AS id_source,
        entity_source_pk_value,
        gn_meta.get_id_dataset_by_uuid('${gn2gn_dataset_uuid}'),
        ref_nomenclatures.get_id_nomenclature('NAT_OBJ_GEO', cd_nomenclature_geo_object_nature),
        ref_nomenclatures.get_id_nomenclature('TYP_GRP', cd_nomenclature_grp_typ),
        grp_method,
        ref_nomenclatures.get_id_nomenclature('METH_OBS', cd_nomenclature_obs_technique),
        ref_nomenclatures.get_id_nomenclature('STATUT_BIO', cd_nomenclature_bio_status),
        ref_nomenclatures.get_id_nomenclature('ETA_BIO', cd_nomenclature_bio_condition),
        ref_nomenclatures.get_id_nomenclature('NATURALITE', cd_nomenclature_naturalness),
        ref_nomenclatures.get_id_nomenclature('PREUVE_EXIST', cd_nomenclature_exist_proof),
        ref_nomenclatures.get_id_nomenclature('STATUT_VALID', cd_nomenclature_valid_status),
        ref_nomenclatures.get_id_nomenclature('NIV_PRECIS', cd_nomenclature_diffusion_level),
        ref_nomenclatures.get_id_nomenclature('STADE_VIE', cd_nomenclature_life_stage),
        ref_nomenclatures.get_id_nomenclature('SEXE', cd_nomenclature_sex),
        ref_nomenclatures.get_id_nomenclature('OBJ_DENBR', cd_nomenclature_obj_count),
        ref_nomenclatures.get_id_nomenclature('TYP_DENBR', cd_nomenclature_type_count),
        ref_nomenclatures.get_id_nomenclature('SENSIBILITE', cd_nomenclature_sensitivity),
        ref_nomenclatures.get_id_nomenclature('STATUT_OBS', cd_nomenclature_observation_status),
        ref_nomenclatures.get_id_nomenclature('DEE_FLOU', cd_nomenclature_blurring),
        ref_nomenclatures.get_id_nomenclature('STATUT_SOURCE', cd_nomenclature_source_status),
        ref_nomenclatures.get_id_nomenclature('TYP_INF_GEO', cd_nomenclature_info_geo_type),
        ref_nomenclatures.get_id_nomenclature('OCC_COMPORTEMENT', cd_nomenclature_behaviour),
        ref_nomenclatures.get_id_nomenclature('STAT_BIOGEO', cd_nomenclature_biogeo_status),
        reference_biblio,
        count_min,
        count_max,
        cd_nom,
        cd_hab,
        nom_cite,
        meta_v_taxref,
        sample_number_proof,
        digital_proof,
        non_digital_proof,
        altitude_min,
        altitude_max,
        depth_min,
        depth_max,
        place_name,
        the_geom_4326,
        the_geom_point,
        the_geom_local,
        precision,
        id_area_attachment,
        date_min,
        date_max,
        validator,
        validation_comment,
        observers,
        determiner,
        ref_nomenclatures.get_id_nomenclature('METH_DETERMIN', cd_nomenclature_determination_method),
        comment_context,
        comment_description,
        additional_data,
        meta_validation_date,
        meta_create_date,
        meta_update_date,
        last_action
    FROM gn2gn_imports.synthese ;

\echo '----------------------------------------------------------------------------'
\echo 'COMMIT if all is ok:'
COMMIT;
